# セキュリティ実装ガイド

## 🔒 実装されたセキュリティ機能

### 1. パスワードハッシュ化
- **SHA-256**ハッシュを使用してパスワードをハッシュ化
- JWT_SECRETをソルトとして使用し、セキュリティを強化
- 平文パスワードは一切データベースに保存されません
- ログインAPIでパスワードを検証時にハッシュを比較

### 2. JWT認証
- **JSON Web Token (JWT)** を使用した認証システム
- トークンの有効期限: 24時間
- すべてのAPI呼び出しでJWTトークンを検証

### 3. アクセス制御
- **認証ミドルウェア (`authMiddleware`)**: すべての保護されたエンドポイントでJWTを検証
- **管理者ミドルウェア (`adminOnly`)**: 管理者専用エンドポイントでロールをチェック
- 以下のエンドポイントは認証が必須:
  - 予約管理 (GET/POST/PUT/DELETE `/reservations`)
  - 拠点管理 (GET/POST/DELETE `/locations`)
  - スタッフ管理 (GET/POST/DELETE `/staff`)
  - ユーザー管理 (GET/POST/PUT/DELETE `/api/users`)

### 4. セッション管理
- **sessionStorage**を使用（localStorageの代わり）
- ブラウザタブを閉じるとセッションが自動的に削除
- CSRF攻撃のリスクを軽減

### 5. ログの最小化
- パスワードは一切ログに出力されません
- エラーメッセージに機密情報を含めません
- デバッグログは最小限に抑えられています

### 6. 初回セットアップ
- デフォルトパスワード: `ChangeMe123!`
- **初回ログイン時にパスワード変更を強制** (requirePasswordChange フラグ)
- 初期セットアップAPIは認証不要ですが、既にデータが存在する場合はスキップされます

---

## 🔑 初回ログイン手順

### 管理者アカウント
```
ユーザー名: manager
パスワード: ChangeMe123!
```

**⚠️ 重要: 初回ログイン後、必ず「設定」からパスワードを変更してください。**

---

## 🛡️ API エンドポイントのセキュリティ

### 認証不要のエンドポイント
- `POST /api/auth/login` - ログイン
- `POST /setup` - 初期セットアップ（初回のみ）
- `GET /health` - ヘルスチェック

### 認証必須のエンドポイント
すべてのリクエストに `Authorization: Bearer <JWT_TOKEN>` ヘッダーが必要です。

#### 一般スタッフがアクセス可能
- `GET /reservations` - 予約一覧取得
- `POST /reservations` - 予約作成
- `PUT /reservations/:id` - 予約更新
- `DELETE /reservations/:id` - 予約削除
- `PATCH /reservations/:id/payment` - 決済ステータス変更
- `GET /locations` - 拠点一覧取得
- `GET /staff` - スタッフ一覧取得
- `PUT /api/users/:id` - 自分のプロフィール更新

#### 管理者のみアクセス可能
- `GET /api/users` - 全ユーザー取得
- `POST /api/users` - ユーザー作成
- `PUT /api/users/:id` - 他ユーザーの更新（管理者のみ）
- `DELETE /api/users/:id` - ユーザー削除
- `POST /locations` - 拠点追加
- `DELETE /locations/:id` - 拠点削除
- `POST /staff` - スタッフ追加
- `DELETE /staff/:id` - スタッフ削除

---

## 🔐 パスワードポリシー

- 最小文字数: **8文字**
- 新しいスタッフアカウント作成時にパスワードが設定されます
- `requirePasswordChange: true` フラグにより初回ログイン時に変更を促します

---

## 📝 今後の改善案

### 推奨される追加セキュリティ対策

1. **JWT_SECRET の環境変数化**
   - 現在はデフォルト値が設定されていますが、本番環境では必ず環境変数から読み込んでください
   ```bash
   # Supabaseの環境変数に設定
   JWT_SECRET=your-super-secret-random-string-here
   ```

2. **レート制限（Rate Limiting）**
   - ログインAPIにレート制限を実装してブルートフォース攻撃を防止

3. **二要素認証（2FA）**
   - 管理者アカウントに2FAを実装

4. **監査ログ**
   - 重要な操作（ユーザー作成、削除、パスワード変更）をログに記録

5. **HTTPS強制**
   - すべての通信をHTTPSで行う（Supabaseはデフォルトでサポート）

6. **CSRFトークン**
   - 状態変更操作にCSRFトークンを追加

7. **IPホワイトリスト**
   - 管理者機能へのアクセスを特定のIPアドレスに制限

---

## 🚨 セキュリティインシデント対応

### パスワードが漏洩した場合
1. 影響を受けたユーザーアカウントを即座に無効化
2. すべてのユーザーに強制パスワードリセットを実施
3. JWT_SECRETを変更してすべてのトークンを無効化
4. 監査ログを確認して不正アクセスを調査

### トークンが漏洩した場合
1. JWT_SECRETを変更
2. すべてのユーザーに再ログインを要求
3. 監査ログで不正アクセスを確認

---

## 📞 問い合わせ

セキュリティに関する問題を発見した場合は、直ちに開発チームに報告してください。

---

**最終更新: 2025年11月1日**
